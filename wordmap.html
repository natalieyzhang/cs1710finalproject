<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Word Map Visualization</title>

  <!-- D3 & d3-cloud -->
  <script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.7/d3.layout.cloud.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: transparent;
      color: #222;
    }

    #app {
      max-width: 1100px;
      margin: 20px auto 40px;
      padding: 0 16px;
    }

    #controls {
      text-align: center;
      margin-bottom: 16px;
    }

    #controls button {
      background: #ffffff;
      border-radius: 999px;
      border: 1px solid #d0d0e0;
      padding: 8px 18px;
      margin: 0 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    #controls button.active {
      background: #8f304e;
      border-color: #8f304e;
      color: #ffffff;
    }

    #controls button:hover:not(.active) {
      background: #f0f0ff;
    }

    #vis-container {
      position: relative;
      height: 600px;

  /* Make it transparent */
      background: transparent;

  /* Remove rounded corners, shadows, borders */
      border-radius: 0;
      box-shadow: none;
      border: none;

      overflow: visible; /* optional, lets words/popup breathe */
      padding: 0;
    }


    #word-svg {
      width: 100%;
      height: 100%;
    }

    text.word {
      cursor: pointer;
      fill: #7d1d3b;
      transition: fill 0.15s ease, transform 0.15s ease;
    }

    text.word:hover {
      fill: #8f304e;
    }

    /* Popup styles */
    #word-popup {
      position: absolute;
      display: none;
      max-width: 340px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.3);
      padding: 10px 12px 12px;
      z-index: 10;
    }

    #word-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    #popup-word {
      font-weight: 700;
      font-size: 18px;
      color: #111827;
    }

    #close-popup {
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 999px;
    }

    #close-popup:hover {
      background: #f3f4f6;
      color: #111827;
    }


    #generate-responses {
      border: none;
      background:#8f304e;
      color: #ffffff;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      margin-bottom: 8px;
      white-space: nowrap;
    }

    #generate-responses:hover {
      background: #8f304e;
    }

    #responses-container {
      max-height: 220px; /* scrollable area */
      overflow-y: auto;
      border-top: 1px solid #e5e7eb;
      padding-top: 6px;
      margin-top: 4px;
    }

    .response-item {
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 8px;
      color: #111827;
    }

    .response-item strong {
      font-weight: 700;
    }

    .response-index {
      font-weight: 600;
      margin-right: 4px;
      color: #6b7280;
    }

    /* Simple scrollbar tweak */
    #responses-container::-webkit-scrollbar {
      width: 6px;
    }

    #responses-container::-webkit-scrollbar-track {
      background: transparent;
    }

    #responses-container::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 999px;
    }

    #error-message {
      text-align: center;
      color: #b91c1c;
      font-size: 14px;
      padding-top: 20px;
      display: none;
    }
    .message-prefix {
      color: #f07392; /* purple example ‚Äî use any color you like */
      font-style: italic;
      font-weight: 500; /* optional, a little stronger */
    }
    @keyframes floatWord {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-4px);
      }
    }

/* All words get a bob animation; timing will be randomized in JS */
    text.word {
      animation-name: floatWord;
      animation-timing-function: ease-in-out;
      animation-iteration-count: infinite;
    }


  </style>
</head>
<body>
  <div id="app">
    <div id="controls">
      <button data-dataset="adjectives" class="active">Adjectives</button>
      <button data-dataset="verbs">Verbs</button>
      <button data-dataset="nouns">Nouns</button>
    </div>

    <div id="vis-container">
      <svg id="word-svg"></svg>

      <div id="word-popup">
        <div id="word-popup-header">
          <div id="popup-word"></div>
          <button id="close-popup" title="Close">&times;</button>
        </div>
        <button id="generate-responses">
          Generate 5 new example responses
        </button>
        <div id="responses-container"></div>
      </div>

      <div id="error-message"></div>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const datasets = {
      adjectives: { file: 'adjectives.csv', wordsByKeyword: null, wordsArray: null },
      verbs: { file: 'verbs.csv', wordsByKeyword: null, wordsArray: null },
      nouns: { file: 'nouns.csv', wordsByKeyword: null, wordsArray: null }
    };

    let currentDatasetName = 'adjectives';
    let currentWordData = null;

    const containerEl = document.getElementById('vis-container');
    const svg = d3.select('#word-svg');
    const errorMessageEl = document.getElementById('error-message');

    function getSvgSize() {
      const bbox = containerEl.getBoundingClientRect();
      // Leave some padding for the popup & borders
      return {
        width: bbox.width - 24,
        height: bbox.height - 24
      };
    }

    // ---------- POPUP ----------
    const popupEl = document.getElementById('word-popup');
    const popupWordEl = document.getElementById('popup-word');
    const generateBtn = document.getElementById('generate-responses');
    const responsesContainerEl = document.getElementById('responses-container');
    const closePopupBtn = document.getElementById('close-popup');

    function hidePopup() {
      popupEl.style.display = 'none';
      currentWordData = null;
    }

    closePopupBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      hidePopup();
    });

    // Prevent clicks inside popup from triggering outside handlers
    popupEl.addEventListener('click', (event) => {
      event.stopPropagation();
    });

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightWordInText(word, text) {
      if (!word || !text) return text || '';
      const pattern = new RegExp('\\b' + escapeRegExp(word) + '\\b', 'gi');
      return text.replace(pattern, '<strong>$&</strong>');
    }

    function sampleArray(arr, n) {
      if (!arr || arr.length === 0) return [];
      const copy = arr.slice();
      // Fisher‚ÄìYates shuffle
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function renderResponses(wordData) {
      responsesContainerEl.innerHTML = '';
      const essays = wordData.essays || [];
      const samples = sampleArray(essays, 5);

     if (samples.length === 0) {
        const p = document.createElement('p');
        p.className = 'response-item';
        p.textContent = '(No example responses found for this word.)';
        responsesContainerEl.appendChild(p);
        return;
      }

      samples.forEach((text, idx) => {
      const p = document.createElement('p');
      p.className = 'response-item';

      const indexSpan = document.createElement('span');
      indexSpan.className = 'response-index';
      indexSpan.textContent = `${idx + 1}.`;
      p.appendChild(indexSpan);

      const contentSpan = document.createElement('span');
  
  // ‚¨áÔ∏è italic + colored phrase
      const innerHtml = `
        <span class="message-prefix">You should message me if... </span>
        ${highlightWordInText(wordData.word, text)}
      `;
  
      contentSpan.innerHTML = innerHtml;
      p.appendChild(contentSpan);

      responsesContainerEl.appendChild(p);
    });

}


    function showPopupForWord(textNode, wordData) {
      if (!textNode || !wordData) return;

      currentWordData = wordData;
  // üëá Show word and frequency
      popupWordEl.textContent = `${wordData.word} (frequency: ${wordData.count})`;
      renderResponses(wordData);

  // ... keep the rest the same


      // Make popup visible off-screen first so we can measure it
      popupEl.style.display = 'block';
      popupEl.style.visibility = 'hidden';
      popupEl.style.left = '0px';
      popupEl.style.top = '0px';

      const wordRect = textNode.getBoundingClientRect();
      const containerRect = containerEl.getBoundingClientRect();
      const popupRect = popupEl.getBoundingClientRect();

      const margin = 8;
      let left = wordRect.right - containerRect.left + margin;
      let top = wordRect.top - containerRect.top;

      // If popup would go off the right edge, place it to the left
      const containerWidth = containerRect.width;
      if (left + popupRect.width > containerWidth - margin) {
        left = wordRect.left - containerRect.left - popupRect.width - margin;
      }

      // Keep inside vertical bounds
      if (top + popupRect.height > containerRect.height - margin) {
        top = containerRect.height - popupRect.height - margin;
      }
      if (top < margin) {
        top = margin;
      }

      popupEl.style.left = `${left}px`;
      popupEl.style.top = `${top}px`;
      popupEl.style.visibility = 'visible';
    }

    generateBtn.addEventListener('click', (event) => {
      event.stopPropagation();
      if (currentWordData) {
        renderResponses(currentWordData);
      }
    });

    
    // ---------- WORD CLOUD RENDERING ----------
    function renderWordCloud(wordsData) {
      const { width, height } = getSvgSize();
      svg.attr('width', width).attr('height', height);
      svg.selectAll('*').remove();
      hidePopup();
      errorMessageEl.style.display = 'none';

      if (!wordsData || wordsData.length === 0) {
        errorMessageEl.textContent = 'No words found in this dataset.';
        errorMessageEl.style.display = 'block';
        return;
      }

      const counts = wordsData.map(d => d.count);
      const minCount = d3.min(counts);
      const maxCount = d3.max(counts);

      const fontSizeScale = d3.scaleLinear()
        .domain([minCount, maxCount])
        .range([14, 60]);

      const layout = d3.layout.cloud()
        .size([width, height])
        .words(wordsData.map(d => Object.assign({}, d)))  // clone so we can mutate
        .padding(5)
        .rotate(() => 0)
        .font('system-ui')
        .fontSize(d => fontSizeScale(d.count))
        .on('end', draw);

      layout.start();

      function draw(words) {
        const g = svg.append('g')
          .attr('transform', `translate(${width / 2}, ${height / 2})`);

        g.selectAll('text')
          .data(words)
          .enter()
          .append('text')
          .attr('class', 'word')
          .style('font-size', d => `${d.size}px`)
          .attr('text-anchor', 'middle')
          .attr('transform', d => `translate(${d.x}, ${d.y}) rotate(${d.rotate})`)
          .text(d => d.word)
          .on('click', function (event, d) {
            const dataset = datasets[currentDatasetName];
            const fullData = dataset.wordsByKeyword.get(d.word);
            if (fullData) {
              // Ensure clicking doesn't propagate to container
              event.stopPropagation();
              showPopupForWord(this, fullData);
            }
          });
      }
    }

    // ---------- DATA LOADING ----------
    function normalizeKeywordField(row) {
      // Try a few common cases for the "keyword" column
      return (
        row.keyword ||
        row.Keyword ||
        row.KEYWORD ||
        row.word ||
        row.Word ||
        row.WORD ||
        ''
      );
    }

    function normalizeEssayField(row) {
      // Try a few common cases for the "essay_text" column
      return (
        row.essay_text ||
        row.essay ||
        row.text ||
        row.Essay ||
        row.ESSAY_TEXT ||
        ''
      );
    }

    function loadDataset(name) {
      currentDatasetName = name;
      const dataset = datasets[name];

      if (dataset.wordsArray && dataset.wordsByKeyword) {
        renderWordCloud(dataset.wordsArray);
        return;
      }

      errorMessageEl.textContent = 'Loading data‚Ä¶';
      errorMessageEl.style.display = 'block';

      d3.text(dataset.file)
        .then(text => {
          const rows = d3.csvParse(text);
          const map = new Map();

          rows.forEach(row => {
            const keyRaw = normalizeKeywordField(row);
            const essay = normalizeEssayField(row);
            if (!keyRaw || !essay) return;
            const key = keyRaw.trim();
            if (!key) return;

            if (!map.has(key)) {
              map.set(key, { word: key, count: 0, essays: [] });
            }
            const obj = map.get(key);
            obj.count += 1;
            obj.essays.push(essay);
          });

          const wordsArray = Array.from(map.values());
          dataset.wordsByKeyword = map;
          dataset.wordsArray = wordsArray;

          renderWordCloud(wordsArray);
        })
        .catch(err => {
          console.error('Error loading dataset', name, err);
          errorMessageEl.textContent =
            'Error loading dataset: ' + dataset.file;
          errorMessageEl.style.display = 'block';
        });
    }

    // ---------- UI WIRING ----------
    document.querySelectorAll('#controls button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#controls button')
          .forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const datasetName = btn.getAttribute('data-dataset');
        loadDataset(datasetName);
      });
    });

    // Click anywhere in the container (but not on a word/popup) to close popup
    containerEl.addEventListener('click', () => {
      hidePopup();
    });

    // Optional: re-render on window resize so layout fits container
    window.addEventListener('resize', () => {
      const dataset = datasets[currentDatasetName];
      if (dataset.wordsArray) {
        renderWordCloud(dataset.wordsArray);
      }
    });

    // ---------- INIT ----------
    loadDataset('adjectives');
  </script>
</body>
</html>
