<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Three Lines of Love – OkCupid Essays</title>
  <style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", "Segoe UI", sans-serif;
  color: #8f304e;
}

.page-wrap {
  max-width: 1200px;
  margin: 0 auto;
  padding: 40px 20px 40px;
}

header h1 {
  font-size: 2.4rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #c9184a;
  text-align: center;
  margin-bottom: 4px;
}

.subtitle {
  text-align: center;
  font-size: 0.96rem;
  color: #8f304e;
  opacity: 0.9;
  margin-bottom: 50px;
}

.legend {
  display: flex;
  justify-content: center;
  gap: 18px;
  margin-bottom: 22px;
  font-size: 0.8rem;
  color: #8f304e;
}

.legend-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.legend-swatch {
  width: 14px;
  height: 14px;
  border-radius: 999px;
}

.legend-swatch.connection {
  background: #ff6b81;
}

.legend-swatch.superficial {
  background: #ffb3c6;
}

.legend-swatch.unclear {
  background: #d3c4cf;
}

.line-block {
  margin-bottom: 34px;
  position: relative;
}

.line-label {
  font-size: 0.85rem;
  color: #b03a5d;
  margin-left: 6px;
  margin-bottom: 6px;
}

.clothesline {
  position: relative;
  padding-top: 16px;
}

.line {
  position: relative;
  height: 2px;
  background: #ff8fa3;
  border-radius: 999px;
  box-shadow: 0 2px 4px rgba(201, 24, 74, 0.18);
}

.line::after {
  content: "";
  position: absolute;
  left: 5%;
  right: 5%;
  top: -3px;
  height: 12px;
  background:
    radial-gradient(circle at 0 0, transparent 60%, rgba(0,0,0,0.02) 64%, transparent 70%),
    radial-gradient(circle at 100% 0, transparent 60%, rgba(0,0,0,0.02) 64%, transparent 70%);
  pointer-events: none;
}

.chain-container {
  position: relative;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 8px;
  padding-top: 10px;
}

/* CSS-drawn paper people */
.paper-person {
  position: relative;
  width: 40px;
  height: 70px;
  transform-origin: top center;
  animation: sway 4.2s ease-in-out infinite;
}

.paper-person:nth-child(2n) {
  animation-duration: 4.8s;
}
.paper-person:nth-child(3n) {
  animation-duration: 5.3s;
  animation-delay: 0.2s;
}

@keyframes sway {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(3deg); }
  50% { transform: rotate(0deg); }
  75% { transform: rotate(-3deg); }
  100% { transform: rotate(0deg); }
}

.paper-person::before {
  content: "";
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 9px;
  height: 10px;
  border-radius: 3px;
  box-shadow: 0 2px 4px rgba(201, 24, 74, 0.25);
}

.paper-person.connection::before {
  background: #ff6b81;
}
.paper-person.superficial::before {
  background: #ffb3c6;
}
.paper-person.unclear::before {
  background: #d3c4cf;
}

.head {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 16px;
  height: 16px;
  background: #ffffff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(147, 84, 104, 0.14);
}

.body {
  position: absolute;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  width: 28px;
  height: 32px;
  background: #ffffff;
  border-radius: 12px 12px 10px 10px;
  box-shadow: 0 3px 6px rgba(147, 84, 104, 0.16);
}

.arms {
  position: absolute;
  top: 22px;
  left: 50%;
  transform: translateX(-50%);
  width: 46px;
  height: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.arm {
  width: 16px;
  height: 4px;
  background: #ffffff;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(147, 84, 104, 0.12);
}

.legs {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 22px;
  height: 16px;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.leg {
  width: 7px;
  height: 14px;
  background: #ffffff;
  border-radius: 0 0 8px 8px;
  box-shadow: 0 2px 4px rgba(147, 84, 104, 0.14);
}

.paper-person:hover {
  animation-play-state: paused;
  transform: translateY(-2px);
}

/* Popup anchored by chain */
.popup {
  position: absolute;
  max-width: 360px;
  padding: 12px 12px 10px;
  background: rgba(255, 240, 243, 0.98);
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(201, 24, 74, 0.3);
  border: 1px solid rgba(255, 179, 198, 0.9);
  font-size: 0.8rem;
  color: #8f304e;
  opacity: 0;
  pointer-events: none;
  /* changed from translate(-50%, ...) so we can clamp cleanly */
  transform: translate(0, 6px) scale(0.9);
  transition: opacity 0.22s ease, transform 0.22s ease, top 0.22s ease, left 0.22s ease;
  z-index: 40;
}

.popup.visible {
  opacity: 1;
  pointer-events: all;
  transform: translate(0, 0) scale(1);
}

.popup h2 {
  margin: 0 0 4px;
  font-size: 1rem;
  background: linear-gradient(90deg, #ff6b81, #c9184a);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

#popup-meta {
  margin: 0 0 6px;
  font-size: 0.78rem;
  color: #8f304e;
}

#popup-examples {
  max-height: 150px;
  overflow-y: auto;
}

.popup-example {
  margin: 0 0 4px;
  padding: 4px 6px;
  border-radius: 8px;
  background: #ffe6eb;
  font-size: 0.73rem;
}

#popup-close {
  position: absolute;
  top: 4px;
  right: 8px;
  background: none;
  border: none;
  color: #c9184a;
  font-size: 1rem;
  cursor: pointer;
}

.hidden {
  display: none;
}

@media (max-width: 768px) {
  .page-wrap {
    padding: 16px 10px 28px;
  }
  header h1 {
    font-size: 1.9rem;
  }
}
  </style>

  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <div class="page-wrap">
    <header>
      <p class="subtitle">
        Each paper chain represents how often people talk in terms of genuine connection, superficial attraction, or something in between.
      </p>
    </header>

    <main>
      <section class="legend">
        <div class="legend-item">
          <span class="legend-swatch connection"></span>
          <span>Genuine connection</span>
        </div>
        <div class="legend-item">
          <span class="legend-swatch superficial"></span>
          <span>Superficial attraction</span>
        </div>
        <div class="legend-item">
          <span class="legend-swatch unclear"></span>
          <span>Unclear / mixed / neutral</span>
        </div>
      </section>

      <section id="lines">
        <div class="line-block" data-category="connection">
          <div class="line-label">Genuine connection</div>
          <div class="clothesline">
            <div class="line"></div>
            <div class="chain-container" id="chain-connection"></div>
          </div>
        </div>

        <div class="line-block" data-category="superficial">
          <div class="line-label">Superficial attraction</div>
          <div class="clothesline">
            <div class="line"></div>
            <div class="chain-container" id="chain-superficial"></div>
          </div>
        </div>

        <div class="line-block" data-category="unclear">
          <div class="line-label">Unclear / mixed</div>
          <div class="clothesline">
            <div class="line"></div>
            <div class="chain-container" id="chain-unclear"></div>
          </div>
        </div>
      </section>
    </main>

    <div id="popup" class="popup hidden">
      <button id="popup-close" aria-label="Close">×</button>
      <h2 id="popup-title"></h2>
      <p id="popup-meta"></p>
      <div id="popup-examples"></div>
    </div>
  </div>

  <script>
const DATA_PATH = "../data/essays.csv";
const ESSAY_COLUMN = "essay9";

const CONNECTION_WORDS = [
  "connection","connect","connected","bond","intimate","intimacy","relationship",
  "relationships","partner","partners","love","loving","care","caring","kind",
  "kindness","compassion","empathy","empathic","understanding","understand",
  "trust","honest","honesty","open","openness","vulnerable","vulnerability",
  "respect","loyal","loyalty","support","supportive","listen","listening",
  "communicate","communication","conversation","conversations","affection",
  "together","togetherness","emotional","emotionally","deep","deeper","meaningful"
];

const SUPERFICIAL_WORDS = [
  "hot","sexy","sex","sexx","attractive","attraction","cute","gorgeous",
  "beautiful","pretty","handsome","hottie","looks","appearance","body",
  "fit","toned","muscular","sixpack","skinny","busty","curvy","model",
  "height","tall","short","blonde","brunette","tattoos","style","stylish",
  "fashion","dressed","dress","rich","money","wealthy","status","fame",
  "famous","celebrity","car","bmw","mercedes","audi","lambo"
];

const MAX_EXAMPLES_PER_CAT = 6;

function cleanText(raw) {
  if (!raw) return "";
  return raw
    .replace(/<br\s*\/?>/gi, " ")
    .replace(/[\r\n]+/g, " ")
    .replace(/[^a-zA-Z\s']/g, " ")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim();
}

function tokenize(text) {
  if (!text) return [];
  return text.split(/\s+/).filter(Boolean);
}

function countMatches(tokens, vocab) {
  const set = new Set(vocab);
  let count = 0;
  for (const t of tokens) {
    if (set.has(t)) count++;
  }
  return count;
}

function classifyEssays(rows) {
  const summary = {
    connection: { count: 0, examples: [] },
    superficial: { count: 0, examples: [] },
    unclear: { count: 0, examples: [] }
  };

  rows.forEach(row => {
    const raw = row[ESSAY_COLUMN];
    if (!raw || !raw.trim()) return;

    const cleaned = cleanText(raw);
    if (!cleaned) return;

    const tokens = tokenize(cleaned);
    const connCount = countMatches(tokens, CONNECTION_WORDS);
    const supCount = countMatches(tokens, SUPERFICIAL_WORDS);

    let cat = "unclear";
    if (connCount === 0 && supCount === 0) {
      cat = "unclear";
    } else if (connCount > 0 && supCount === 0) {
      cat = "connection";
    } else if (supCount > 0 && connCount === 0) {
      cat = "superficial";
    } else {
      cat = "unclear";
    }

    summary[cat].count += 1;

    if (summary[cat].examples.length < MAX_EXAMPLES_PER_CAT) {
      const snippet = cleaned.length > 220 ? cleaned.slice(0, 220) + "..." : cleaned;
      summary[cat].examples.push(snippet);
    }
  });

  return summary;
}

function computeChainLengths(summary) {
  const counts = [
    summary.connection.count,
    summary.superficial.count,
    summary.unclear.count
  ];
  const maxCount = Math.max(...counts);

  const lengths = {};
  if (maxCount === 0) {
    lengths.connection = lengths.superficial = lengths.unclear = 0;
    return lengths;
  }

  function scale(count) {
    if (count === 0) return 0;
    const minPeople = 3;
    const maxPeople = 22;
    return Math.round(minPeople + (count / maxCount) * (maxPeople - minPeople));
  }

  lengths.connection = scale(summary.connection.count);
  lengths.superficial = scale(summary.superficial.count);
  lengths.unclear = scale(summary.unclear.count);

  return lengths;
}

function createPaperPerson(category) {
  const person = document.createElement("div");
  person.className = `paper-person ${category}`;

  const head = document.createElement("div");
  head.className = "head";

  const body = document.createElement("div");
  body.className = "body";

  const arms = document.createElement("div");
  arms.className = "arms";
  const armLeft = document.createElement("div");
  armLeft.className = "arm left";
  const armRight = document.createElement("div");
  armRight.className = "arm right";
  arms.appendChild(armLeft);
  arms.appendChild(armRight);

  const legs = document.createElement("div");
  legs.className = "legs";
  const leg1 = document.createElement("div");
  leg1.className = "leg";
  const leg2 = document.createElement("div");
  leg2.className = "leg";
  legs.appendChild(leg1);
  legs.appendChild(leg2);

  person.appendChild(head);
  person.appendChild(body);
  person.appendChild(arms);
  person.appendChild(legs);

  return person;
}

const popupEl = document.getElementById("popup");
const popupTitleEl = document.getElementById("popup-title");
const popupMetaEl = document.getElementById("popup-meta");
const popupExamplesEl = document.getElementById("popup-examples");
const popupCloseBtn = document.getElementById("popup-close");

function hidePopup() {
  popupEl.classList.remove("visible");
  popupEl.classList.add("hidden");
}

popupCloseBtn.addEventListener("click", e => {
  e.stopPropagation();
  hidePopup();
});

function showPopup(category, summary, anchorElement) {
  // Fill content first
  let title = "";
  if (category === "connection") title = "Genuine connection";
  if (category === "superficial") title = "Superficial attraction";
  if (category === "unclear") title = "Unclear / mixed";

  const metaCount = summary[category].count;
  popupTitleEl.textContent = title;
  popupMetaEl.textContent =
    metaCount === 1
      ? "1 essay in this category."
      : `${metaCount.toLocaleString()} essays in this category.`;

  popupExamplesEl.innerHTML = "";
  if (summary[category].examples.length) {
    summary[category].examples.forEach(snip => {
      const p = document.createElement("p");
      p.className = "popup-example";
      p.textContent = snip;
      popupExamplesEl.appendChild(p);
    });
  } else {
    const p = document.createElement("p");
    p.className = "popup-example";
    p.textContent = "No sample snippets stored for this category.";
    popupExamplesEl.appendChild(p);
  }

  // Make popup visible so we can measure it
  popupEl.classList.remove("hidden");
  popupEl.classList.add("visible");

  // Reset position for clean measurement
  popupEl.style.left = "0px";
  popupEl.style.top = "0px";

  const containerRect = document.querySelector(".page-wrap").getBoundingClientRect();
  const anchorRect = anchorElement.getBoundingClientRect();
  const popupRect = popupEl.getBoundingClientRect();

  const padding = 12; // inner margin from page-wrap edges

  // Try to put popup below the chain, horizontally centered over it
  let left =
    anchorRect.left - containerRect.left +
    anchorRect.width / 2 -
    popupRect.width / 2;

  let top = anchorRect.bottom - containerRect.top + 8;

  // Clamp horizontally to stay inside .page-wrap
  const minLeft = padding;
  const maxLeft = containerRect.width - padding - popupRect.width;
  left = Math.min(Math.max(left, minLeft), maxLeft);

  // If placing below would go off the bottom, try above
  const maxTop = containerRect.height - padding - popupRect.height;
  if (top > maxTop) {
    top = anchorRect.top - containerRect.top - popupRect.height - 8;
  }

  // Clamp vertically
  const minTop = padding;
  top = Math.min(Math.max(top, minTop), maxTop);

  popupEl.style.left = `${left}px`;
  popupEl.style.top = `${top}px`;
}

function buildVisualization(summary) {
  const lengths = computeChainLengths(summary);

  const config = [
    { cat: "connection", id: "chain-connection" },
    { cat: "superficial", id: "chain-superficial" },
    { cat: "unclear", id: "chain-unclear" }
  ];

  config.forEach(({ cat, id }) => {
    const container = document.getElementById(id);
    container.innerHTML = "";

    const length = lengths[cat] || 0;
    for (let i = 0; i < length; i++) {
      container.appendChild(createPaperPerson(cat));
    }

    const lineBlock = container.closest(".line-block");
    if (lineBlock) {
      lineBlock.addEventListener("click", e => {
        e.stopPropagation();
        showPopup(cat, summary, container);
      });
    }
  });

  document.body.addEventListener("click", e => {
    const withinPopup = popupEl.contains(e.target);
    const isChain =
      e.target.classList.contains("paper-person") ||
      e.target.closest(".line-block");
    if (!withinPopup && !isChain) {
      hidePopup();
    }
  });
}

d3.csv(DATA_PATH).then(rows => {
  const summary = classifyEssays(rows);
  buildVisualization(summary);
});
  </script>
</body>
</html>
