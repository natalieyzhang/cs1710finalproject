<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connection Word Map – Valentine Edition</title>
  <style>
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Poppins", "Segoe UI", sans-serif;
  color: #8f304e;
}

.page-wrap {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px 24px 40px;
}

.subtitle {
  margin: 0 0 24px;
  opacity: 0.9;
  font-size: 0.98rem;
  color: #8f304e;
}

#viz-section {
  margin-bottom: 14px;
}

#wordcloud-container {
  position: relative;
  padding: 18px;
  overflow: hidden;
}

/* Floating hearts background */
.heart {
  position: absolute;
  font-size: 18px;
  color: rgba(255, 153, 180, 0.55);
  animation: floatHeart 12s infinite ease-in-out;
  pointer-events: none;
  user-select: none;
}
.heart1 { top: 90%; left: 10%; animation-delay: 0s; }
.heart2 { top: 100%; left: 40%; animation-delay: 3s; }
.heart3 { top: 95%; left: 70%; animation-delay: 6s; }
.heart4 { top: 105%; left: 85%; animation-delay: 1.5s; }

@keyframes floatHeart {
  0% { transform: translateY(0) scale(0.9); opacity: 0; }
  15% { opacity: 0.6; }
  60% { opacity: 0.4; }
  100% { transform: translateY(-140px) scale(1.2); opacity: 0; }
}

#wordcloud {
  width: 100%;
  height: 520px;
}

.word {
  transition: opacity 0.22s ease, transform 0.22s ease, text-shadow 0.22s ease;
}

#controls {
  margin: 12px 0 6px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.85rem;
  color: #8f304e;
}

/* Anchored popup */
.popup {
  position: absolute;
  min-width: 260px;
  max-width: 360px;
  max-height: 360px;
  padding: 14px 14px 12px;
  background: rgba(255, 240, 243, 0.98);
  color: #8f304e;
  border-radius: 18px;
  box-shadow: 0 18px 50px rgba(201,24,74,0.32);
  opacity: 0;
  pointer-events: none;
  transform: translate(0, 4px) scale(0.9);      /* no more -50% horizontally */
  transition: opacity 0.24s ease, transform 0.24s ease, top 0.24s ease, left 0.24s ease;
  overflow-y: auto;
  z-index: 40;
  border: 1px solid rgba(255, 179, 198, 0.9);
}

.popup.visible {
  opacity: 1;
  pointer-events: all;
  transform: translate(0, 0) scale(1);
}

.popup h3 {
  margin: 0 0 6px;
  font-size: 1.16rem;
  background: linear-gradient(90deg, #ff6b81, #c9184a);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

#popup-meta {
  margin: 0 0 6px;
  font-size: 0.8rem;
  color: #8f304e;
}

#popup-examples {
  font-size: 0.78rem;
  line-height: 1.5;
}

.popup .example-snippet {
  margin: 0 0 6px;
  padding: 5px 7px;
  border-radius: 10px;
  background: #ffe6eb;
  color: #8f304e;
}

.popup .example-snippet span.tag {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.09em;
  opacity: 0.7;
  margin-right: 4px;
  color: #c9184a;
}

#close-popup {
  position: absolute;
  top: 4px;
  right: 8px;
  background: none;
  border: none;
  color: #c9184a;
  font-size: 1.1rem;
  cursor: pointer;
  padding: 0;
}

.popup-more {
  margin-top: 4px;
  border: none;
  padding: 4px 9px;
  border-radius: 999px;
  background: #ff6b81;
  color: #fff;
  font-size: 0.7rem;
  cursor: pointer;
  float: right;
}

.popup-more.hidden {
  display: none;
}

@media (max-width: 900px) {
  #wordcloud {
    height: 420px;
  }
}

</style>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
</head>
<body>
  <div class="page-wrap">
    <h2 style="text-align: center;">Take a look at the most mentioned keywords and these real essay responses from OkCupid users!</h2>
    <main>
      <section id="viz-section">
        <div id="wordcloud-container">
          <!-- Soft floating hearts background -->
          <div class="heart heart1">❤</div>
          <div class="heart heart2">❤</div>
          <div class="heart heart3">❤</div>
          <div class="heart heart4">❤</div>

          <div id="wordcloud"></div>

          <!-- Anchored popup -->
          <div id="popup" class="popup hidden">
            <button id="close-popup" aria-label="Close">×</button>
            <h3 id="popup-word"></h3>
            <p id="popup-meta"></p>
            <div id="popup-examples"></div>
            <button id="popup-more" class="popup-more hidden">Show more</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
// Valentine Edition: clustered layout, anchored popup, word bank

const DATA_PATH = "../data/essays.csv";
const ESSAY_COLUMN = "essay9";

const CONNECTION_SEEDS = [
  "connection","connect","connected","bond","close","closeness","intimate","intimacy",
  "relationship","relationships","partner","partners","friend","friends","friendship",
  "together","togetherness","empathy","compassion","understanding","trust","honesty",
  "honest","openness","open","vulnerable","vulnerability","care","caring","kindness",
  "respect","loyalty","support","supportive","listen","listening","communicate",
  "communication","conversation","conversations","chemistry","affection","love","loving"
];

const STOPWORDS = new Set([
  "a","an","the","and","or","but","if","then","so","of","in","on","for","to",
  "with","at","it","its","is","am","are","was","were","be","been","being",
  "i","me","my","mine","you","your","yours","he","she","they","them","we","us",
  "this","that","these","those","as","by","from","about","just","like","do",
  "does","did","have","has","had","not","no","yes","too","very","can","could",
  "would","will","one","two","get","got","make","made","also","more","most",
  "some","any","all","such","than","when","what","how","who","why","where",
  "into","out","up","down","over","under","again","ever","really","lot","lots",
  "bit","something","everything","nothing","etc","im","ive","youre","dont",
  "cant","wont","didnt","thats","hes","shes","theyre","were","youll","id"
]);

const TOP_N = 50;
const MAX_EXAMPLES_PER_WORD = 8; // we can reveal more via "Show more"

let allWords = [];
let topWords = [];
let extraWords = [];

// --- Text utilities ---
function cleanText(raw) {
  if (!raw) return "";
  return raw
    .replace(/<br\s*\/?>/gi, " ")
    .replace(/[\r\n]+/g, " ")
    .replace(/[^a-zA-Z\s']/g, " ")
    .toLowerCase()
    .replace(/\s+/g, " ")
    .trim();
}

function tokenize(text) {
  if (!text) return [];
  return text.split(/\s+/).filter(Boolean);
}

function hasConnectionSeed(tokens) {
  const set = new Set(tokens);
  for (const s of CONNECTION_SEEDS) {
    if (set.has(s)) return true;
  }
  return false;
}

// --- Build stats with a lightweight "NLP-ish" co-occurrence heuristic ---
function buildWordStats(rows) {
  const wordStats = {};

  rows.forEach((row, idx) => {
    const raw = row[ESSAY_COLUMN];
    const cleaned = cleanText(raw);
    if (!cleaned) return;

    const tokens = tokenize(cleaned);
    if (!tokens.length) return;

    const uniqueTokens = Array.from(new Set(tokens));
    const hasSeed = hasConnectionSeed(uniqueTokens);

    uniqueTokens.forEach((w) => {
      if (w.length < 3) return;
      if (STOPWORDS.has(w)) return;

      if (!wordStats[w]) {
        wordStats[w] = {
          word: w,
          totalResponses: 0,
          coWithConnection: 0,
          examples: []
        };
      }

      wordStats[w].totalResponses += 1;

      if (hasSeed) {
        wordStats[w].coWithConnection += 1;

        if (wordStats[w].examples.length < MAX_EXAMPLES_PER_WORD) {
          const tokenIndex = tokens.indexOf(w);
          const start = Math.max(0, tokenIndex - 10);
          const end = Math.min(tokens.length, tokenIndex + 14);
          const snippet =
            tokens.slice(start, end).join(" ") +
            (end < tokens.length ? "..." : "");
          wordStats[w].examples.push({ idx, snippet });
        }
      }
    });
  });

  const words = [];
  for (const w in wordStats) {
    const s = wordStats[w];
    if (s.coWithConnection === 0) continue;
    const purity = s.coWithConnection / s.totalResponses;
    const score = purity * Math.log10(2 + s.totalResponses);
    s.score = score;
    s.purity = purity;
    words.push(s);
  }
  return words;
}

// --- Popup controls ---
const popupEl = document.getElementById("popup");
const popupWordEl = document.getElementById("popup-word");
const popupMetaEl = document.getElementById("popup-meta");
const popupExamplesEl = document.getElementById("popup-examples");
const popupMoreBtn = document.getElementById("popup-more");
const closePopupBtn = document.getElementById("close-popup");

let currentPopupWord = null;
let showingAllExamples = false;

function hidePopup() {
  popupEl.classList.remove("visible");
  popupEl.classList.add("hidden");
  currentPopupWord = null;
  showingAllExamples = false;
  popupMoreBtn.classList.add("hidden");

  d3.selectAll("text.word")
    .transition()
    .duration(220)
    .style("opacity", 1)
    .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})scale(1)`)
    .style("text-shadow", "none");
}

closePopupBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  hidePopup();
});

popupMoreBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  if (!currentPopupWord) return;
  showingAllExamples = !showingAllExamples;
  renderPopupExamples(currentPopupWord);
  popupMoreBtn.textContent = showingAllExamples ? "Show less" : "Show more";
});

function renderPopupExamples(wordObj) {
  if (!wordObj.examples || !wordObj.examples.length) {
    popupExamplesEl.innerHTML =
      `<p class="example-snippet">No stored snippets, but this word frequently appears in connection-themed responses.</p>`;
    popupMoreBtn.classList.add("hidden");
    return;
  }

  const toShow = showingAllExamples
    ? wordObj.examples
    : wordObj.examples.slice(0, 3);

  popupExamplesEl.innerHTML = toShow
    .map((ex, i) =>
      `<p class="example-snippet"><span class="tag">Example ${i + 1}</span>${ex.snippet}</p>`
    )
    .join("");

  if (wordObj.examples.length > 3) {
    popupMoreBtn.classList.remove("hidden");
    popupMoreBtn.textContent = showingAllExamples ? "Show less" : "Show more";
  } else {
    popupMoreBtn.classList.add("hidden");
  }
}

function showPopupAnchored(target, wordObj) {
  if (!wordObj) return;

  currentPopupWord = wordObj;
  showingAllExamples = false;

  // Fill content
  popupWordEl.textContent = wordObj.word;
  popupMetaEl.innerHTML =
    `<strong>${wordObj.totalResponses}</strong> responses contain this word. ` +
    `Connection-focus score: <strong>${wordObj.purity.toFixed(2)}</strong>`;
  renderPopupExamples(wordObj);

  const container = document.getElementById("wordcloud-container");
  const containerRect = container.getBoundingClientRect();
  const wordRect = target.getBoundingClientRect();

  // Make sure popup is "active" so we can measure it
  popupEl.classList.remove("hidden");
  popupEl.classList.add("visible");

  // Reset position for a clean measurement
  popupEl.style.left = "0px";
  popupEl.style.top = "0px";

  const popupRect = popupEl.getBoundingClientRect();
  const popupWidth = popupRect.width;
  const popupHeight = popupRect.height;

  const padding = 12; // inner margin from container edges

  // Start by trying to place it below the word, centered-ish
  let left = wordRect.left - containerRect.left + wordRect.width / 2 - popupWidth / 2;
  let top = wordRect.bottom - containerRect.top + 10;

  // Clamp horizontally
  const minLeft = padding;
  const maxLeft = containerRect.width - padding - popupWidth;
  left = Math.min(Math.max(left, minLeft), maxLeft);

  // If placing below would go off the bottom, try above the word
  const maxTop = containerRect.height - padding - popupHeight;
  if (top > maxTop) {
    top = wordRect.top - containerRect.top - popupHeight - 10;
  }

  // Clamp vertically
  const minTop = padding;
  top = Math.min(Math.max(top, minTop), maxTop);

  popupEl.style.left = `${left}px`;
  popupEl.style.top = `${top}px`;
}


// --- Word cloud rendering ---
function renderWordCloud(words) {
  const container = document.getElementById("wordcloud");
  const width = container.clientWidth || 800;
  const height = container.clientHeight || 520;

  d3.select("#wordcloud").selectAll("*").remove();

  const svg = d3
    .select("#wordcloud")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const maxCount = d3.max(words, d => d.totalResponses) || 1;

  const fontSizeScale = d3
    .scaleSqrt()
    .domain([1, maxCount])
    .range([14, 64]);

  const colorScale = d3
    .scaleLinear()
    .domain([0, 0.6, 1])
    .range(["#f8b7c3", "#ff6b81", "#c9184a"]);

  const layout = d3.layout.cloud()
    .size([width, height])
    .words(
      words.map(d => ({
        text: d.word,
        size: fontSizeScale(d.totalResponses),
        datum: d
      }))
    )
    .padding(2)
    .rotate(() => (Math.random() < 0.16 ? 90 : 0))
    .spiral("rectangular")
    .font("system-ui")
    .fontSize(d => d.size)
    .on("end", wordsPlaced => {
      const group = svg
        .append("g")
        .attr("transform", `translate(${width / 2},${height / 2})`);

      const texts = group
        .selectAll("text")
        .data(wordsPlaced)
        .enter()
        .append("text")
        .attr("class", "word")
        .style("font-family", "system-ui, -apple-system, sans-serif")
        .style("font-size", d => d.size + "px")
        .style("fill", d =>
          colorScale(d.datum.purity || 0.5)
        )
        .style("cursor", "pointer")
        .style("text-shadow", "0 3px 6px rgba(201,24,74,0.25)")
        .attr("text-anchor", "middle")
        .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
        .text(d => d.text)
        .on("click", function (event, d) {
          event.stopPropagation();
          const clicked = d3.select(this);
          const datum = d.datum;

          d3.selectAll("text.word")
            .transition()
            .duration(200)
            .style("opacity", 0.25)
            .attr("transform", w => `translate(${w.x},${w.y})rotate(${w.rotate})scale(1)`)
            .style("text-shadow", "0 3px 6px rgba(201,24,74,0.25)");

          clicked
            .transition()
            .duration(260)
            .style("opacity", 1)
            .attr("transform", w => `translate(${w.x},${w.y})rotate(${w.rotate})scale(1.4)`)
            .style("text-shadow", "0 6px 14px rgba(201,24,74,0.55)");

          showPopupAnchored(this, datum);
        });

      // click background to reset
      svg.on("click", () => {
        hidePopup();
      });
    });

  layout.start();
}

// --- Word bank ---
function renderWordBank(words) {
  const container = d3.select("#wordbank");
  container.selectAll("*").remove();

  const items = container
    .selectAll(".wordbank-item")
    .data(words, d => d.word)
    .enter()
    .append("div")
    .attr("class", "wordbank-item")
    .text(d => d.word)
    .on("click", (event, d) => {
      const svgText = d3
        .selectAll("text.word")
        .filter(w => w && w.text === d.word)
        .node();

      if (svgText) {
        d3.selectAll("text.word")
          .transition()
          .duration(200)
          .style("opacity", 0.25)
          .attr("transform", w => `translate(${w.x},${w.y})rotate(${w.rotate})scale(1)`)
          .style("text-shadow", "0 3px 6px rgba(201,24,74,0.25)");

        d3.select(svgText)
          .transition()
          .duration(260)
          .style("opacity", 1)
          .attr("transform", w => `translate(${w.x},${w.y})rotate(${w.rotate})scale(1.4)`)
          .style("text-shadow", "0 6px 14px rgba(201,24,74,0.55)");

        showPopupAnchored(svgText, d);
      }
    });

  const searchInput = document.getElementById("wordbank-search");
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();
    if (!q) {
      items.classed("dimmed", false);
      return;
    }
    items.classed("dimmed", d => !d.word.includes(q));
  });
}

// --- Controls ---
function applyMinCountFilter(minCount) {
  const filtered = topWords.filter(w => w.totalResponses >= minCount);
  hidePopup();
  renderWordCloud(filtered);
}

function setupControls() {
  const slider = document.getElementById("minCountSlider");
  const label = document.getElementById("minCountLabel");

  slider.addEventListener("input", () => {
    const val = Number(slider.value);
    label.textContent = val;
    applyMinCountFilter(val);
  });

  const toggleBtn = document.getElementById("toggle-wordbank");
  const wordbank = document.getElementById("wordbank");

  toggleBtn.addEventListener("click", () => {
    const collapsed = wordbank.classList.contains("collapsed");
    if (collapsed) {
      wordbank.classList.remove("collapsed");
      toggleBtn.textContent = "Hide";
    } else {
      wordbank.classList.add("collapsed");
      toggleBtn.textContent = "Show all";
    }
  });
}

// --- Main init ---
d3.csv(DATA_PATH).then(rows => {
  const validRows = rows.filter(r => r[ESSAY_COLUMN] && r[ESSAY_COLUMN].trim());
  allWords = buildWordStats(validRows);

  allWords.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.totalResponses - a.totalResponses;
  });

  topWords = allWords.slice(0, TOP_N);
  extraWords = allWords.slice(TOP_N);

  renderWordCloud(topWords);
  renderWordBank(allWords);
  setupControls();
});

</script>
</body>
</html>
